(function(window){window.Fr=window.Fr||{};Fr.voice={mp3WorkerPath:"/tpl/js/record/mp3Worker.js",stream:false,input:false,init_called:false,stopRecordingTimeout:false,init:function(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;if(navigator.getUserMedia===false){alert('getUserMedia() is not supported in your browser');}
this.context=new AudioContext();}catch(e){alert('Web Audio API is not supported in this browser');}},record:function(output,finishCallback,recordingCallback){var finishCallback=finishCallback||function(){};var recordingCallback=recordingCallback||function(){};if(this.init_called===false){this.init();this.init_called=true;}
var $that=this;navigator.getUserMedia({audio:true},function(stream){$that.input=$that.context.createMediaStreamSource(stream);if(output===true){$that.input.connect($that.context.destination);}
$that.recorder=new Recorder($that.input,{'mp3WorkerPath':$that.mp3WorkerPath,'recordingCallback':recordingCallback});$that.stream=stream;$that.recorder.record();finishCallback(stream);},function(){alert('No live audio input');});},pause:function(){this.recorder.stop();},resume:function(){this.recorder.record();},stop:function(){this.recorder.stop();this.recorder.clear();this.stream.getTracks().forEach(function(track){track.stop();});return this;},export:function(callback,type){this.recorder.exportWAV(function(blob){Fr.voice.callExportCallback(blob,callback,type);});},exportMP3:function(callback,type){this.recorder.exportMP3(function(blob){Fr.voice.callExportCallback(blob,callback,type);});},callExportCallback:function(blob,callback,type){if(typeof type==="undefined"||type=="blob"){callback(blob);}else if(type==="base64"){var reader=new window.FileReader();reader.readAsDataURL(blob);reader.onloadend=function(){base64data=reader.result;callback(base64data);};}else if(type==="URL"){var url=URL.createObjectURL(blob);callback(url);}},stopRecordingAfter:function(time,callback){var callback=callback||function(){};clearTimeout(this.stopRecordingTimeout);this.stopRecordingTimeout=setTimeout(function(){Fr.voice.pause();callback();},time);}};})(window);